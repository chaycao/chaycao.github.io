---
title:      ç³»ç»Ÿå­¦ä¹ Stream
date:       2020-05-31 
key: 20200531
author:     ChayCao    
catalog: true 
tags:  Java
---

Java8ä¸­æœ€å¤§çš„ä¸¤ä¸ªäº®ç‚¹ï¼Œä¸€ä¸ªæ˜¯Lambdaè¡¨è¾¾å¼ï¼Œå¦ä¸€ä¸ªå°±æ˜¯Streamã€‚æ–°ç‰¹æ€§çš„åŠ å…¥ï¼Œä¸€å®šæ˜¯ä¸ºäº†æŸç§éœ€æ±‚ï¼Œé‚£ä¹ˆStreamæ˜¯ä»€ä¹ˆï¼Œå®ƒèƒ½å¸®åŠ©æˆ‘ä»¬åšä»€ä¹ˆï¼Ÿé¦–å…ˆçœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š

æœ‰è¿™æ ·ä¸€ä»½æ•°æ®ï¼Œä¸€ç»„è€ƒå·List<Paper>ï¼Œæ¯ä¸ªPaperæœ‰ä¸‰ä¸ªå±æ€§åˆ†åˆ«æ˜¯å­¦ç”Ÿåå­—studentNameã€è¯¾ç¨‹åç§°classNameå’Œåˆ†æ•°scoreã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦ä»ä¸­æ‰¾å‡ºè¯­æ–‡ä¸åŠæ ¼ï¼ˆåˆ†æ•°ä½äº60ï¼‰çš„å­¦ç”Ÿåå­—ï¼Œå¹¶ä¸”æŒ‰åˆ†æ•°ä»é«˜åˆ°ä½æ’åºã€‚åœ¨ä¸ä½¿ç”¨Java8æ–°ç‰¹æ€§ä¹‹å‰ï¼Œç›¸ä¿¡å¤§éƒ¨åˆ†äººéƒ½æ˜¯åƒä¸‹é¢è¿™æ ·å†™çš„ï¼š

```java
public static List<String> getFailedPaperStudentNamesByJava7(List<Paper> papers) {
    // ç­›é€‰å‡ºä¸åŠæ ¼çš„è€ƒå·
    List<Paper> failedPapers = new ArrayList<>();
    for (Paper paper : papers) {
        if (paper.getClassName().equals("è¯­æ–‡") 
            && paper.getScore() < 60) {
            failedPapers.add(paper);
        }
    }
    // æŒ‰åˆ†æ•°ä»é«˜åˆ°ä½æ’åº
    Collections.sort(failedPapers, new Comparator<Paper>() {
        @Override
        public int compare(Paper o1, Paper o2) {
            return o2.getScore() - o1.getScore();
        }
    });
    // è®°ä¸‹ä¸åŠæ ¼çš„å­¦ç”Ÿåå­—
    List<String> failedPaperStudentNames = new ArrayList<>();
    for (Paper failedPaper : failedPapers) {
        failedPaperStudentNames.add(failedPaper.getStudentName());
    }
    return failedPaperStudentNames;
}
```

ä¸‹é¢æ˜¯ç”¨Java8çš„Lambdaè¡¨è¾¾å¼+Streamæ”¹å†™çš„ç‰ˆæœ¬ï¼š

```java
public static List<String> getFailedPaperStudentNamesByJava8(List<Paper> papers) {
    return papers.stream()
        .filter(p -> p.getClassName().equals("è¯­æ–‡")
                && p.getScore() < 60)
        .sorted((p1, p2) -> p2.getScore() - p1.getScore())
        .map(Paper::getStudentName)
        .collect(Collectors.toList());
}
```

å¯ç›´è§‚çš„çœ‹å‡ºï¼Œä»£ç é‡å°‘äº†ï¼Œåªç”¨äº†ä¸€è¡Œä»£ç æŠŠæ‰€æœ‰æ“ä½œ**é“¾æ¥**èµ·æ¥äº†ã€‚æˆ‘ä»¬å†ç»†çœ‹ä¸‹ï¼Œä»è¿™æ–¹æ³•çš„åå­—ä¸Šå»ç†è§£ï¼Œé¦–å…ˆé€šè¿‡`stream`ä»Listè·å¾—Streamï¼Œç„¶åå¯ä»¥ä½¿ç”¨æµå¼æ“ä½œå¤„ç†æ•°æ®ï¼Œå…ˆæ˜¯`filter`ç­›é€‰å‡ºè¯­æ–‡è¯¾ä¸”ä¸åŠæ ¼çš„è€ƒå·ï¼Œæ¥ç€`sorted`å¯¹åˆ†æ•°æ’åºï¼Œå†æ˜¯`map`è·å¾—æ¯ä¸ªPaperä¸­çš„å­¦ç”Ÿåå­—ï¼Œæœ€å`collect`æŠŠæ‰€æœ‰çš„åå­—æ”¶é›†æˆä¸€ä¸ªListã€‚å¯çœ‹å‡ºï¼Œä»è¯­ä¹‰ä¸Šçš„ç†è§£ä¹Ÿæ›´ä¸ºç›´è§‚äº†ï¼Œåœ¨ç­›é€‰è¯­æ–‡è¯¾ä¸åŠæ ¼çš„è¯•å·æ—¶ï¼Œæˆ‘ä»¬ä¸æ˜¯ä½¿ç”¨å‘½ä»¤å¼å†™æ³•ï¼ˆéå†ï¼Œç„¶ååˆ¤æ–­ï¼Œå†æ”¾åˆ°ä¸€ä¸ªæ–°çš„Listé‡Œï¼‰ï¼Œè€Œæ˜¯ç±»ä¼¼SQLä¸­çš„whereæ¡ä»¶ï¼Œé€šè¿‡**å£°æ˜å¼**å†™æ³•ç›´æ¥ç»™å‡ºæ•°æ®éœ€è¦ç¬¦åˆçš„æ¡ä»¶ï¼Œä¾¿èƒ½å¾—åˆ°éœ€è¦çš„æ•°æ®ã€‚

æˆ‘ä»¬è¯´äº†å¾ˆä¹…çš„â€œStreamâ€ï¼Œåˆ°åº•ä»€ä¹ˆæ˜¯â€œStreamâ€ï¼Œç¬”è€…ä»Stream APIè¿™ä¸ªè§’åº¦è°ˆè‡ªå·±çš„ç†è§£ï¼š

>  Streamæ˜¯Javaæä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œè¯¥æ¥å£å…è®¸ä»¥**å£°æ˜å¼**çš„å†™æ³•å¤„ç†æ•°æ®ï¼Œå¯ä»¥æŠŠæ“ä½œ**é“¾æ¥**èµ·æ¥ï¼Œå½¢æˆæ•°æ®å¤„ç†æµæ°´çº¿ï¼Œè¿˜èƒ½å°†æ•°æ®å¤„ç†ä»»åŠ¡**å¹¶è¡ŒåŒ–**ã€‚

å£°æ˜å¼å’Œé“¾æ¥æ“ä½œï¼Œå‰é¢çš„ä¾‹å­å·²ç»èƒ½çœ‹å‡ºã€‚é‚£ä»€ä¹ˆæ˜¯å¹¶è¡ŒåŒ–ï¼Œä¾‹å¦‚ç»Ÿè®¡å­¦ç”Ÿåå­—ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¯¥ä»»åŠ¡åˆ’åˆ†æˆå¤šä¸ªï¼Œäº¤ç»™å¤šä¸ªCPUåˆ†åˆ«è®¡ç®—ï¼Œæœ€åå†æ±‡æ€»ç»“æœï¼Œè¿™ä¸€ç³»åˆ—å¤æ‚æ“ä½œï¼Œå¯äº¤ç»™Streamå®Œæˆï¼Œå¦‚ä¸‹ï¼š

```java
public static List<String> getFailedPaperStudentNamesByJava8(List<Paper> papers) {
    return papers.parallelStream()
        .filter(p -> p.getClassName().equals("è¯­æ–‡")
                && p.getScore() < 60)
        .sorted((p1, p2) -> p2.getScore() - p1.getScore())
        .map(Paper::getStudentName)
        .collect(Collectors.toList());
}
```

åªæ˜¯å°†`stream()`æ–¹æ³•æ”¹ä¸º`parallelStream()`æ–¹æ³•å°±èƒ½å°†è¯¥ä»»åŠ¡å¹¶è¡ŒåŒ–ï¼Œæ˜¯ä¸æ˜¯ååˆ†ç®€å•ã€‚

é€šè¿‡ä»¥ä¸Šä»‹ç»ï¼Œæƒ³å¿…å·²å¯¹Streamæœ‰äº†åˆæ­¥è®¤è¯†ï¼Œä¸‹é¢å¼€å§‹ç³»ç»Ÿå­¦ä¹ Streamã€‚

## 1. æµå’Œé›†åˆ

é¦–å…ˆæˆ‘ä»¬è¿˜æ˜¯è¦å¼„æ¸…æ¥šæµå’Œé›†åˆ**åœ¨æ¦‚å¿µä¸Šçš„åŒºåˆ«**ã€‚é›†åˆï¼Œä¾‹å¦‚Listã€Setã€Treeç­‰ï¼Œæ˜¯ä¸€ç§å­˜å‚¨æ•°æ®çš„æ•°æ®ç»“æ„ã€‚å…³äºæ•°æ®ï¼Œæ˜¯å·²ç»å­˜åœ¨äº†çš„ï¼Œæˆ‘ä»¬åªæ˜¯é€šè¿‡ä¸€ç§æ•°æ®ç»“æ„å°†æ•°æ®ç»„ç»‡èµ·æ¥ï¼Œä¾¿äºæŸç§æ–¹å¼è¯»å–æˆ–ä¿æŒæŸç§ç»“æ„ã€‚æµä¸åŒäºé›†åˆçš„åœ°æ–¹åœ¨äºæ•°æ®å¹¶éåœ¨ä½¿ç”¨å‰å…¨éƒ¨è·å¾—ï¼Œè€Œæ˜¯åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æŒ‰éœ€è·å¾—ã€‚ä¾‹å¦‚æ–‡ä»¶æµï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`readline`å°†æ–‡ä»¶ä¸€è¡Œä¸€è¡Œçš„è¯»å–ã€‚è¿˜æœ‰è§†é¢‘æµï¼Œæˆ‘ä»¬å¯ä»¥è¾¹çœ‹è¾¹ä¸‹è½½ï¼Œä¸ç”¨ç­‰å°†æ‰€æœ‰æ•°æ®ä¸‹è½½å®Œæ¯•æ‰èƒ½è§‚çœ‹ã€‚

æ‰€ä»¥è™½ç„¶æˆ‘ä»¬éƒ½èƒ½ä»é›†åˆã€æµä¸­è·å–æ•°æ®ï¼Œä½†æ•°æ®äº§ç”Ÿçš„æ—¶é—´æ˜¯æœ‰åŒºåˆ«çš„ï¼Œé›†åˆçš„æ•°æ®æ˜¯**é¢„å…ˆäº§ç”Ÿ**çš„ï¼Œè€Œæµåˆ™æ˜¯æ ¹æ®éœ€è¦**å®æ—¶äº§ç”Ÿ**çš„ã€‚ä¸¤è€…çš„ç‰¹æ€§ä¹Ÿå¯¼è‡´ç”¨é€”ä¸Šçš„å·®å¼‚ï¼Œ**é›†åˆä¾§é‡å­˜å‚¨**ï¼Œ**æµä¾§é‡è®¡ç®—**ã€‚å› æ­¤æˆ‘ä»¬å¸¸å¬åˆ°çš„æµå¼è®¡ç®—çš„å«æ³•ã€‚

ä¸‹é¢è¯´ä¸‹æµå’Œé›†åˆ**åœ¨ä½¿ç”¨ä¸Šçš„åŒºåˆ«**ã€‚é›†åˆï¼Œå¯ä»¥éšæ—¶å–ç”¨ï¼Œä½†**æµåœ¨åˆ›å»ºååªèƒ½è¢«ä½¿ç”¨ä¸€æ¬¡**ï¼Œè‹¥é‡å¤æ¶ˆè´¹ï¼Œåˆ™ä¼šæŠ¥é”™ã€‚

```java
List<String> list = Arrays.asList("A", "B", "C");
Stream<String> stream = list.stream();
stream.forEach(System.out::print);
stream.forEach(System.out::print);
// ABC
// java.lang.IllegalStateException: stream has already been operated upon or closed
```

å¦å¤–ï¼Œé›†åˆåœ¨éå†æ—¶ï¼Œå°±åƒæˆ‘ä»¬å‰é¢æè¿°çš„ä¾‹å­ï¼Œåªèƒ½é€šè¿‡ç¨‹åºå‘˜ç¼–å†™ for-each è¿™ç§æ˜¾ç¤ºçš„ä»£ç å»è¿­ä»£ï¼Œè¿™è¢«ç§°ä½œ**å¤–éƒ¨è¿­ä»£**ã€‚è€Œæµåœ¨éå†æ—¶ï¼Œä¾‹å¦‚mapä¼šå¯¹æµä¸­çš„æ¯ä¸ªå…ƒç´ è¿›è¡Œå¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å†™å…·ä½“çš„è¿­ä»£ä»£ç ï¼Œè€Œæ˜¯äº¤ç”±Javaå†…éƒ¨å®Œæˆï¼Œè¿™è¢«ç§°ä½œ**å†…éƒ¨è¿­ä»£**ã€‚å†…éƒ¨è¿­ä»£çš„å¥½å¤„åœ¨äºï¼Œå®ƒæ˜¯ä¸€ä¸ªé»‘ç›’ã€‚ä½ éœ€è¦çš„æ˜¯è¿­ä»£ï¼Œé‚£Javaåªè¦å®Œæˆä½ çš„ç›®æ ‡å°±è¡Œäº†ã€‚è€Œè‡³äºå¦‚ä½•è¿­ä»£ï¼Œåˆ™äº¤ç”±Javaæ¥å®Œæˆï¼Œè¿™å°±ä¸ºä¼˜åŒ–æä¾›äº†å¯èƒ½ï¼Œä¼˜åŒ–çš„æ–¹å‘æœ‰ä¸¤ç‚¹ï¼Œä¸€æ˜¯æ›´ä¼˜åŒ–çš„é¡ºåºæ¥å¤„ç†ï¼ŒäºŒæ˜¯å°†æ“ä½œå¹¶è¡ŒåŒ–ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨å­¦ç”Ÿçš„ç¤ºä¾‹ä¸­ï¼Œåªæ˜¯å°†`stream`æ”¹æˆ`parallelStream()`ï¼Œåç»­å…¶ä»–çš„mapæ“ä½œå¯ä»¥æ ¹æ®åˆ¤æ–­æ˜¯å¹¶è¡Œæµä»è€Œå°†ä»»åŠ¡å¹¶è¡ŒåŒ–ï¼Œè€Œæˆ‘ä»¬ä¸ç”¨ä¿®æ”¹mapæ“ä½œã€‚

ä¸‹é¢æˆ‘ä»¬æ¥å­¦ä¹ å¦‚ä½•ä½¿ç”¨æµã€‚

## 2. åˆ›å»ºæµ

åœ¨å¯¹æµè¿›è¡Œæ“ä½œä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è·å¾—ä¸€ä¸ª`Stream`å¯¹è±¡ï¼Œåˆ›å»ºæµæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ã€‚

### 2.1 é›†åˆ

`Collection`çš„é»˜è®¤æ–¹æ³•`stream()`ï¼Œå¯ä»¥ç”±é›†åˆç±»åˆ›å»ºæµã€‚

```java
List<String> list = Arrays.asList("A", "B", "C");
Stream<String> stream = list.stream();
```

### 2.2 å€¼

`Stream`çš„é™æ€æ–¹æ³•`of(T... values)`ï¼Œé€šè¿‡æ˜¾ç¤ºå€¼åˆ›å»ºæµï¼Œå¯æ¥å—ä»»æ„æ•°é‡çš„å‚æ•°ã€‚

```java
Stream<String> stream = Stream.of("A","B","C");
```

### 2.3 æ•°ç»„

`Arrays`çš„é™æ€æ–¹æ³•`stream(T[] array)`ä»æ•°ç»„åˆ›å»ºæµï¼Œæ¥å—ä¸€ä¸ªæ•°ç»„å‚æ•°ã€‚

```java
String[] ss = new String[]{"A", "B", "C"};
Stream<String> stream = Arrays.stream(ss);
```

### 2.4 æ–‡ä»¶ 

NIOä¸­æœ‰è¾ƒå¤šé™æ€æ–¹æ³•åˆ›å»ºæµï¼Œä¾‹å¦‚`Files`çš„é™æ€æ–¹æ³•`lines(Path path)`ä»è¿”å›æŒ‡å®šæ–‡ä»¶ä¸­çš„å„è¡Œæ„æˆçš„å­—ç¬¦ä¸²æµã€‚

```java
try (Stream<String> stream = Files.lines(Paths.get("data.txt"))) {
    stream.forEach(System.out::print);
} catch (IOException e) {
}
```

### 2.5 å‡½æ•°

`Stream`çš„é™æ€`iterate`å’Œ`generate`å¯æ ¹æ®å‡½æ•°è®¡ç®—åˆ›å»º**æ— é™æµ**ã€‚é¦–å…ˆçœ‹ä¸‹`iterate`ï¼Œé€šå¸¸ç”¨äºä¾æ¬¡ç”Ÿæˆä¸€ç³»åˆ—å€¼ï¼Œå…¶å£°æ˜å¦‚ä¸‹ï¼š

```java
Stream<T> iterate(final T seed, final UnaryOperator<T> f)
```

`seed`ä¸ºåˆå§‹å€¼ï¼Œ`UnaryOperator<T>`æ˜¯`Function<T,R>`çš„å­ç±»ï¼ŒåŒºåˆ«åœ¨äºè§„å®šè¾“å…¥ã€è¾“å‡ºéƒ½æ˜¯`T`ç±»å‹ï¼Œä¸‹é¢çœ‹ä¸ªç¤ºä¾‹ï¼š

```java
Stream.iterate(0, n -> n + 1)
    .forEach(System.out::println);
```

è¯¥ç¤ºä¾‹ä¼šæ ¹æ®åˆå§‹å€¼ï¼Œç„¶åé€šè¿‡å‡½æ•°è®¡ç®—ä¾æ¬¡å¾—åˆ°ä¸‹ä¸€ä¸ªå€¼ï¼Œ0ã€1ã€2......ä½ å¯ä»¥è¯•ç€è¿è¡Œä¸‹ï¼Œå‘ç°æ ¹æœ¬åœä¸ä¸‹æ¥ï¼Œè¿™å°±æ˜¯åˆšåˆšè¯´åˆ°çš„æ— é™æµã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡`limit(n)`æ¥å¯¹æ— é™æµåšé™åˆ¶ã€‚

```java
Stream.iterate(0, n -> n + 1)
    .limit(10)
    .forEach(System.out::println);
```

æ¥ç€æ˜¯`generate`ï¼Œä¸åŒäº`iterate`ä¾æ¬¡æ ¹æ®ä¸Šæ¬¡è®¡ç®—çš„ç»“æœç”Ÿæˆï¼Œ è€Œæ˜¯é€šè¿‡ä¸€ä¸ª`Supplier<T>`å®ä¾‹æä¾›æ–°çš„å€¼ï¼Œå…¶å£°æ˜å¦‚ä¸‹ï¼š

```java
Stream<T> generate(Supplier<T> s)
```

ä¾‹å¦‚ï¼Œæˆ‘ä»¬ç”Ÿæˆ10ä¸ªéšæœºæ•°ï¼š

```java
Stream.generate(Math::random)
    .limit(10)
    .forEach(System.out::println);
```

### 2.6 æ•°å€¼æµ

ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°ä¸Šè¿°ä»‹ç»çš„`Stream<T>`ä½¿ç”¨äº†æ³›å‹ï¼Œæ‰€ä»¥å¯ä»¥é€‚ç”¨äºä»»æ„å¼•ç”¨ç±»å‹ï¼Œè€Œå¯¹äºåŸå§‹ç±»å‹åˆ™åªèƒ½ä½¿ç”¨å…¶åŒ…è£…ç±»ï¼Œä¾‹å¦‚ï¼š

```java
Stream.of(1, 2, 3)
    .forEach(n -> {
        System.out.println(n.getClass()); // Integer
        int x = n * 2; // éœ€è¦æ‹†ç®±
    });
```

Streamåœ¨å¤„ç†åŸå§‹ç±»å‹ä¸Šä¼šç”±äºè£…ç®±æ‹†ç®±é€ æˆè¾ƒå¤§çš„æ€§èƒ½æŸè€—ï¼Œæ‰€ä»¥Java8æä¾›äº†ä¸‰ç§ç‰¹æ®Šçš„æµæ¥å£`IntStream`ã€`DoubleStream`ã€`LongStream`ï¼Œå°†æµä¸­çš„å…ƒç´ ç‰¹åŒ–ä¸º`int`ã€`double`å’Œ`long`ã€‚

```java
IntStream.of(1, 2, 3)
    .forEach(n -> {
        int x = n * 2; // nä¸ºint
    });
```

é™¤äº†ä½¿ç”¨`of`åˆ›å»ºæµï¼Œè¿˜å¯ä»¥å°†æ™®é€šæµè½¬æˆæ•°å€¼æµï¼Œ`mapToInt`ã€`mapToDouble`å’Œ`mapToLong`ã€‚

```java
Stream.of(1, 2, 3)
    .mapToInt(Integer::intValue)
    .forEach(n -> {
        int x = n * 2; // nä¸ºint
    });
```

æ•°å€¼æµä¹Ÿèƒ½è½¬æˆæ™®é€šæµï¼Œ`boxed`è£…ç®±ã€‚

```java
IntStream.of(1, 2, 3)
    .boxed()
    .forEach(n -> {
        int x = n * 2; // nä¸ºInteger
    });
```

## 3. æµçš„æ“ä½œ

æµåˆ›å»ºå¥½äº†ï¼Œä¸‹é¢å­¦ä¹ å¯¹æµè¿›è¡Œæ“ä½œã€‚æµçš„æ“ä½œåˆ†ä¸ºä¸¤ç§ï¼š

- **ä¸­é—´æ“ä½œ**ï¼šè¿”å›ä¸€ä¸ªStreamå¯¹è±¡ï¼Œå¯ä»¥å°†ä¸€ç³»åˆ—ä¸­é—´æ“ä½œæ„æˆä¸€æ¡æµçš„æµæ°´çº¿ï¼ˆç±»ä¼¼æ„é€ å™¨æ¨¡å¼ï¼‰
- **ç»ˆç«¯æ“ä½œ**ï¼šæ‰§è¡Œæµæ°´çº¿ï¼Œè¿”å›ä¸æ˜¯æµçš„ç»“æœï¼ˆä¹Ÿå¯æ˜¯voidï¼‰

```java
public static List<String> getFailedPaperStudentNamesByJava8(List<Paper> papers) {
    return papers.parallelStream()
        .filter(p -> p.getClassName().equals("è¯­æ–‡")  // Stream<Paper>
                && p.getScore() < 60)
        .sorted((p1, p2) -> p2.getScore() - p1.getScore())  // Stream<Paper>
        .map(Paper::getStudentName)  // Stream<String>
        .collect(Collectors.toList()); // List<String>
}
```

è¿™é‡Œçš„`filter`ã€`sorted`ã€`map`å°±æ˜¯ä¸­é—´æ“ä½œï¼Œ`collect`ä¸ºç»ˆç«¯æ“ä½œã€‚ç»ˆç«¯æ“ä½œç”¨äºæ‰§è¡Œæµæ°´çº¿æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿæ„æ€æ˜¯å¦‚æœæ²¡æœ‰ç»ˆç«¯æ“ä½œï¼Œå°†ä¸ä¼šæ‰§è¡Œå‰é¢é“¾æ¥çš„ä¸­é—´æ“ä½œã€‚ä¾‹å¦‚ï¼š

```java
List<String> list = Arrays.asList("A", "B", "C");
list.stream()
    .map(s -> {
        System.out.print(s);
        return s;
    });
// æ— è¾“å‡º
```

æ— ç»ˆç«¯æ“ä½œçš„æƒ…å†µä¸‹ï¼Œä¸­é—´æ“ä½œ`map`é‡Œçš„ä»£ç å—å°†ä¸ä¼šæ‰§è¡Œï¼Œä¸ä¼šæœ‰è¾“å‡ºã€‚è€Œæˆ‘ä»¬åœ¨æ­¤åŸºç¡€ä¸ŠåŠ ä¸Šä¸€ä¸ªç»ˆç«¯æ“ä½œ`forEach`ï¼Œä¾¿èƒ½è§¦å‘æµæ°´çº¿çš„æ‰§è¡Œã€‚

```java
List<String> list = Arrays.asList("A", "B", "C");
list.stream()
    .map(s -> {
        System.out.print(s);
        return s;
    })
    .forEach(s -> {});
// ABC
```

ä¸‹é¢æ¥çœ‹ä¸‹å¸¸ç”¨çš„æµæ“ä½œã€‚

### 3.1 ç­›é€‰

**ï¼ˆ1ï¼‰filter**

```java
Stream<T> filter(Predicate<? super T> predicate)
```

è¿‡æ»¤

- æ¥å—ä¸€ä¸ªè°“è¯Predicateï¼ˆT -> booleanï¼‰
- è¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç¬¦åˆè°“è¯çš„å…ƒç´ çš„æµã€‚

```java
List<String> list = Arrays.asList("AA", "AB", "BC");
list.stream()
    .filter(s -> s.startsWith("A"))
    .forEach(System.out::println);
// AA
// AB
```

**ï¼ˆ2ï¼‰distinct**

```java
Stream<T> distinct()
```

å»é‡

- æ ¹æ®æµä¸­å…ƒç´ çš„hashCodeå’Œequalsæ–¹æ³•æ¯”è¾ƒå…ƒç´ 

- è¿”å›ä¸€ä¸ªå…ƒç´ å„å¼‚çš„æµ

```java
List<String> list = Arrays.asList("A", "A", "B");
list.stream()
    .distinct()
    .forEach(System.out::print);
// AB
```

### 3.2 åˆ‡ç‰‡

**ï¼ˆ1ï¼‰limit**

```java
Stream<T> limit(long maxSize);
```

æˆªæ–­

- æ¥å—ä¸€ä¸ªé•¿åº¦
- è¿”å›ä¸€ä¸ªä¸è¶…è¿‡ç»™å®šé•¿åº¦çš„æµ

```java
List<String> list = Arrays.asList("A", "B", "C");
list.stream()
    .limit(2)
    .forEach(System.out::print);
// AB
```

**ï¼ˆ2ï¼‰skip**

```java
Stream<T> skip(long n)
```

è·³è¿‡å…ƒç´ 

- æŒ‡å®šè·³è¿‡å‰nä¸ªå…ƒç´ 
- å¦‚æœå…ƒç´ ä¸è¶³nä¸ªï¼Œè¿”å›ä¸€ä¸ªç©ºæµ

```java
List<String> list = Arrays.asList("A", "B", "C");
list.stream()
    .skip(2)
    .forEach(System.out::print);
// C
```

### 3.3 æ˜ å°„

**ï¼ˆ1ï¼‰map**

```java
<R> Stream<R> map(Function<? super T, ? extends R> mapper)
```

å¯¹æ¯ä¸ªå…ƒç´ åº”ç”¨å‡½æ•°

- æ¥å—ä¸€ä¸ªå‡½æ•°ï¼ˆT -> Rï¼‰
- å°†æ¯ä¸€ä¸ªå…ƒç´ æ˜ å°„æˆä¸€ä¸ªæ–°çš„å…ƒç´ 

```java
List<Paper> papers = Arrays.asList(
    new Paper("å°æ˜", "è¯­æ–‡", 40),
    new Paper("å°çº¢", "è¯­æ–‡", 80),
    new Paper("å°è“", "è¯­æ–‡", 50)
);
papers.stream()
    .map(Paper::getStudentName)
    .forEach(System.out::println);
// å°æ˜
// å°çº¢
// å°è“
```

**ï¼ˆ2ï¼‰flatMap**

```java
<R> Stream<R> flatMap(Function<? super T, ? extends Stream<? extends R>> mapper)
```

æµçš„æ‰å¹³åŒ–ï¼Œä»€ä¹ˆæ„æ€ï¼Œå…ˆçœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š

```java
List<String> list = Arrays.asList("ABC", "DEF", "GHI");
list.stream()
    .map(s -> s.split("")) // Stream<String[]>
    .forEach(System.out::println); 
// [Ljava.lang.String;@2f4d3709
// [Ljava.lang.String;@4e50df2e
// [Ljava.lang.String;@1d81eb93
```

æˆ‘ä»¬æƒ³å°†å­—ç¬¦ä¸²â€œABCâ€ï¼Œâ€œDEFâ€ï¼Œâ€œGHIâ€ä¸‰ä¸ªå­—ç¬¦ä¸­çš„æ¯ä¸ªå­—ç¬¦ç»„åˆæˆä¸€ä¸ªæµç„¶åæ‰“å°å‡ºæ¥ï¼Œä½†æ˜¯ä¸Šè¿°çš„å†™æ³•ï¼Œé€šè¿‡`split`å‡½æ•°æ‹†åˆ†äº†`String[]`æ•°ç»„ï¼Œæµä¸­çš„å…ƒç´ ä¹Ÿè¢«æ˜ å°„æˆäº†æ•°ç»„ï¼Œä¾‹å¦‚`String[]{"A", "B", "C"}`ï¼Œæ‰€ä»¥`forEach`æ‰“å°å¾—åˆ°çš„ç»“æœæ˜¯æ•°ç»„åœ°å€ã€‚

æˆ‘ä»¬å¦‚ä½•æ‰èƒ½æŠŠæ•°ç»„ä¸­çš„å…ƒç´ ç»„åˆåœ¨ä¸€èµ·ï¼Œå¾—åˆ°`"A", "B", "C", "D"...`çš„ä¸€ä¸ªæµå‘¢ã€‚è¿™å°±éœ€è¦æ‰å¹³åŒ–çš„å¤„ç†ã€‚`flatMap`æ¥å—ä¸€ä¸ªå‡½æ•°ï¼ˆT -> Streamï¼‰ï¼ŒæŠŠæµä¸­æ¯ä¸ªå…ƒç´ æ˜ å°„ä¸ºä¸€ä¸ªæµï¼Œç„¶åå†æŠŠæ‰€æœ‰çš„æµç»„åˆæˆä¸€ä¸ªæœ€ç»ˆçš„æµã€‚ä¾‹å¦‚è¿™é‡Œçš„å…ƒç´ æ˜¯`String[]`ï¼Œé‚£æˆ‘ä»¬å°±æŠŠæ•°ç»„æ˜ å°„æˆæµ`Arrays::stream`ï¼Œè¿™æ ·å°±èƒ½æŠŠæ¯ä¸ªæ•°ç»„é‡Œçš„å…ƒç´ è¿æ¥åœ¨ä¸€èµ·äº†ã€‚

```java
List<String> list = Arrays.asList("ABC", "DEF", "GHI");
list.stream()
    .map(s -> s.split("")) // Stream<String[]>
    .flatMap(Arrays::stream) // Steam<String>
    .forEach(System.out::println);
```

### 3.4 åŒ¹é…

**ï¼ˆ1ï¼‰anyMatch**

```java
boolean anyMatch(Predicate<? super T> predicate)
```

è‡³å°‘åŒ¹é…ä¸€ä¸ªå…ƒç´ 

- æ¥å—ä¸€ä¸ªè°“è¯ï¼ˆT -> booleanï¼‰
- å¦‚æœæœ‰ä¸€ä¸ªå…ƒç´ åŒ¹é…ï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›false

```java
List<String> list = Arrays.asList("A", "B", "C");
list.stream()
    .map(s -> {
        System.out.print(s);
        return s;
    })
    .anyMatch(s -> s.startsWith("B")); // true
// AB
```

å½“é‡åˆ°Bæ—¶ï¼ŒåŒ¹é…åˆ°äº†ï¼Œä¾¿ä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šå†è¿­ä»£åç»­å…ƒç´ ï¼Œè¿™æ˜¯ä¸€ç§çŸ­è·¯æ“ä½œã€‚

**ï¼ˆ2ï¼‰allMatch**

```java
boolean allMatch<Predicate<? super T> predicate>
```

åŒ¹é…æ‰€æœ‰å…ƒç´ 

- æ¥å—ä¸€ä¸ªè°“è¯ï¼ˆT -> booleanï¼‰
- æ‰€æœ‰æ‰€æœ‰å…ƒç´ åŒ¹é…ï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›false
- å½“æœ‰ä¸€ä¸ªå…ƒç´ ä¸åŒ¹é…ï¼Œå°±ä¼šçŸ­è·¯è¿”å›

```java
List<String> list = Arrays.asList("A", "B", "C");
list.stream()
    .map(s -> {
        System.out.println(s);
        return s;
    })
    .allMatch(s -> s.startsWith("B")); // false
// A
```

**ï¼ˆ3ï¼‰nonMatch**

```java
boolean nonMatch(Predicate<? super T> predicate)
```

æ‰€æœ‰å…ƒç´ ä¸åŒ¹é…

- æ¥å—ä¸€ä¸ªè°“è¯ï¼ˆT -> booleanï¼‰
- æ‰€æœ‰å…ƒç´ åŒ¹é…ï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›false
- å½“æœ‰ä¸€ä¸ªå…ƒç´ åŒ¹é…ï¼Œå°±ä¼šçŸ­è·¯è¿”å›

```java
List<String> list = Arrays.asList("A", "B", "C");
list.stream()
    .map(s -> {
        System.out.println(s);
        return s;
    })
    .noneMatch(s -> s.startsWith("B")); // false
// A
```

### 3.5 æŸ¥æ‰¾

**ï¼ˆ1ï¼‰findAny**

```java
Optional<T> findAny()
```

è¿”å›å½“å‰æµä¸­çš„ä»»æ„å…ƒç´ ï¼Œç”¨Optionalå°è£…å…ƒç´ ï¼Œè¿«ä½¿æ˜¾ç¤ºæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ã€‚

**ï¼ˆ2ï¼‰findFirst**

```java
Optional<T> findFirst()
```

è¿”å›å½“å‰æµä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ 

**å¯¹æ¯”ï¼š**

ä¸¤è€…éƒ½æ˜¯è¿”å›ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœä¸å…³å¿ƒè¿”å›çš„å…ƒç´ æ˜¯å“ªä¸ªï¼Œä¼˜å…ˆä½¿ç”¨findAnyï¼Œå› ä¸ºè¿™æ ·åœ¨å¹¶è¡Œä¸Šçš„é™åˆ¶æ›´å°‘ï¼Œå¯ä¼˜åŒ–çš„ç©ºé—´æ›´å¤§ã€‚

### 3.6 å½’çº¦

reduce

```java
// æœ‰åˆå§‹å€¼
T reduce(T identity, BinaryOperator<T> accumulator)
// æ— åˆå§‹å€¼
Optional<T> reduce(BinaryOperator<T> accumulator)    
```

é€šè¿‡æ¥æ”¶ä¸€ä¸ªBinaryOperator`(T, T) -> T`ï¼Œå°†ä¸¤ä¸ªå…ƒç´ ç»“åˆäº§ç”Ÿä¸€ä¸ªæ–°å€¼ã€‚reduceå°†ä¸€ç›´æ‰§è¡Œè¯¥æ“ä½œç›´åˆ°æœ€åæµä¸­åªå‰©ä¸€ä¸ªå…ƒç´ è¿”å›ã€‚

```java
int[] nums = new int[]{1, 2, 3, 4, 5};
int sum = IntStream.of(nums).reduce(0, Integer::sum); // 15
int max = IntStream.of(nums).reduce(Integer::max).orElse(-1); // 5
int min = IntStream.of(nums).reduce(Integer::min).orElse(-1); // 1
```

### 3.7 æ•°å€¼æµçš„ç‰¹æ®Šæ“ä½œ

åœ¨2.6èŠ‚ä¸­æˆ‘ä»¬è¯´è¿‡é’ˆå¯¹åŸå§‹ç±»å‹æœ‰ç‰¹æ®Šçš„åŸå§‹ç±»å‹æµï¼Œç”±äºéƒ½æ˜¯æ•°å€¼ï¼Œæ‰€ä»¥ä¹Ÿè®¾è®¡äº†äº›é’ˆå¯¹æ•°å€¼çš„æ–¹æ³•ã€‚

```java
int[] nums = new int[]{1, 2, 3, 4, 5};
int sum = IntStream.of(nums).sum(); // 15ï¼Œç­‰åŒreduce(0, Integer::sum)
int max = IntStream.of(nums).max().orElse(-1); // 5ï¼Œç­‰åŒreduce(Integer::max).orElse(-1)
int min = IntStream.of(nums).min().orElse(-1); // 1ï¼Œç­‰åŒreduce(Integer::min).orElse(-1)
double avg = IntStream.of(nums).average().orElse(-1); //3.0
```

### 3.8 æ”¶é›†

`collect`åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­å·²ç»è§è¿‡äº†ï¼Œå¯ä»¥å°†æµä¸­çš„å…ƒç´ è¿›è¡Œæ±‡æ€»ã€‚

```java
<R, A> R collect(Collector<? super T, A, R> collector);
```

æ¥æ”¶ä¸€ä¸ªCollectoræ”¶é›†å™¨ã€‚åœ¨Collectorsä¸­å·²ç»å†…ç½®äº†ä¸€äº›å¸¸ç”¨çš„æ”¶é›†å™¨ã€‚

- `toList()`ï¼šå°†å…ƒç´ æ”¶é›†æˆä¸€ä¸ªList
- `toSet()`ï¼šå°†å…ƒç´ æ”¶é›†æˆä¸€ä¸ªSet
- `counting()`ï¼šç»Ÿè®¡å…ƒç´ æ•°é‡
- `maxBy(Comparator<? super T> comparator)`ï¼šè·å–å…ƒç´ ä¸­çš„æœ€å¤§å€¼
- `minBy(Comparator<? super T> comparator)`ï¼šè·å–å…ƒç´ ä¸­çš„æœ€å°å€¼
- `summingInt(ToIntFunction<? super T> mapper)`ï¼šå°†å…ƒç´ æ˜ å°„æˆä¸€ä¸ªintå€¼ï¼Œç„¶åæ±‚å’Œï¼Œç±»ä¼¼çš„è¿˜æœ‰doubleå’Œlongã€‚
- `averagingInt(ToIntFunction<? super T> mapper)`ï¼šå°†å…ƒç´ æ˜ å°„æˆä¸€ä¸ªintå€¼ï¼Œç„¶åæ±‚å¹³å‡ã€‚
- `summarizingInt(ToIntFunction<? super T> mapper)`ï¼šå°†å…ƒç´ æ˜ å°„æˆä¸€ä¸ªintå€¼ï¼Œç„¶åå¾—åˆ°ä¸€ä¸ª`IntSummaryStatistics`å¯¹è±¡ï¼ŒåŒ…å«äº†ç»Ÿè®¡æ•°ã€æ€»å’Œã€æœ€å¤§å€¼ã€æœ€å°å€¼å’Œå¹³å‡å€¼ã€‚
- `joining()`ï¼šæŠŠå…ƒç´ toSting()çš„ç»“æœè¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è½½ç‰ˆæœ¬ï¼Œæ¥æ”¶ä¸€ä¸ªåˆ†éš”ç¬¦å‚æ•°
- `groupingBy(Function<? super T, ? extends K> classifier)`ï¼šæ¥æ”¶ä¸€ä¸ª`Function`ï¼Œè¿”å›ä¸€ä¸ª`Map<K, List<T>>`ã€‚é€šè¿‡Functionçš„è¿”å›å€¼ä½œä¸ºKeyï¼Œç„¶åå°†å…·æœ‰ç›¸åŒKeyçš„å…ƒç´ ï¼Œç»„åˆæˆListã€‚

ä¸‹é¢çœ‹ç¤ºä¾‹ï¼š

```java
List<Paper> papers = Arrays.asList(
    new Paper("å°æ˜", "è¯­æ–‡", 40),
    new Paper("å°æ˜", "æ•°å­¦", 80),
    new Paper("å°çº¢", "è¯­æ–‡", 80),
    new Paper("å°çº¢", "æ•°å­¦", 80),
    new Paper("å°è“", "è¯­æ–‡", 50),
    new Paper("å°è“", "æ•°å­¦", 60)
);
// æ‰€æœ‰è¯­æ–‡å·å­
List<Paper> chinesePapers = papers.stream()
    .filter(p -> p.getClassName().equals("è¯­æ–‡"))
    .collect(toList());
// æ‰€æœ‰å­¦ç§‘
Set<String> classNames = papers.stream()
    .map(Paper::getClassName)
    .collect(toSet());
// æœ€é«˜åˆ†çš„å·å­ï¼Œæœ€ä½åˆ†æ”¹æˆminByå°±è¡Œ
Paper maxScorePaper = papers.stream()
    .collect(maxBy((p1, p2) -> p1.getScore() - p2.getScore())).get();
// æ€»åˆ†æ•°
int sumScore = papers.stream()
    .collect(summingInt(Paper::getScore));
// å¹³å‡åˆ†
double avgScore = papers.stream()
    .collect(averagingInt(Paper::getScore));
// ç»Ÿè®¡æ•°ã€æ€»å’Œã€æœ€å¤§å€¼ã€æœ€å°å€¼å’Œå¹³å‡å€¼
IntSummaryStatistics summaryStatistics = papers.stream()
    .collect(summarizingInt(Paper::getScore));
long count = summaryStatistics.getCount();
long sum = summaryStatistics.getSum();
int max = summaryStatistics.getMax();
int min = summaryStatistics.getMin();
double avg = summaryStatistics.getAverage();
// å­¦ç”Ÿåå­—è¿æ¥åœ¨ä¸€èµ·
String studentNameStr = papers.stream()
    .map(Paper::getStudentName)
    .distinct()
    .collect(joining(","));
// æŒ‰å­¦ç§‘å°†å·å­åˆ†ç»„
Map<String, List<Paper>> groupPapers = papers.stream()
    .collect(groupingBy(Paper::getClassName));
```

ä»¥ä¸Šä»‹ç»çš„æ˜¯å¸¸ç”¨çš„Collectorï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ ¹æ®éœ€è¦è‡ªå®šä¹‰Collectorï¼Œæœ¬æ–‡å°±ä¸å™è¿°äº†ã€‚

## 4. æ€»ç»“

æœ¬æ–‡åˆ—ä¸¾äº†åœ¨æ—¥å¸¸å¼€å‘ä¸­è¾ƒä¸ºå¸¸ç”¨çš„æµæ“ä½œï¼Œä½†æ˜¯è¿˜æœ‰æœªæ¶‰åŠä¹‹å¤„ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥ç›´æ¥çœ‹Streamçš„APIã€‚æœ¬æ–‡ä¹Ÿæ²¡æœ‰è®²è¿°å¹¶è¡Œæµï¼Œè™½ç„¶ç”¨æ³•ç®€å•ï¼Œä½†æ˜¯èƒ½å¦çœŸæ­£æé«˜æ•ˆç‡ï¼Œè¿˜æ˜¯è¦çœ‹å…·ä½“æƒ…å†µï¼Œè¿˜ç¼ºä¹ç»éªŒå°±ä¸å™è¿°äº†ã€‚è¿˜æ˜¯å…ˆæŒæ¡åŸºæœ¬çš„æµå¼æ“ä½œå§ğŸ˜€
